# Learn RAG - Hybrid Search ç³»çµ±

ä¸€å€‹åŸºæ–¼ Hybrid Searchï¼ˆæ··åˆæœå°‹ï¼‰çš„ RAGï¼ˆRetrieval-Augmented Generationï¼‰ç³»çµ±ï¼Œçµåˆ BM25 é—œéµå­—æª¢ç´¢å’Œå‘é‡èªç¾©æª¢ç´¢ï¼Œå¯¦ç¾æ›´ç²¾æº–çš„æ–‡æª”æª¢ç´¢ã€‚

## ğŸ“‹ å°ˆæ¡ˆç°¡ä»‹

æœ¬å°ˆæ¡ˆå¯¦ä½œäº†ä¸€å€‹å®Œæ•´çš„ RAG ç³»çµ±ï¼Œç”¨æ–¼å¾ arXiv å­¸è¡“è«–æ–‡ä¸­æª¢ç´¢ç›¸é—œè³‡è¨Šã€‚ç³»çµ±çµåˆäº†å…©ç¨®æª¢ç´¢æ–¹æ³•ï¼š
- **BM25 æª¢ç´¢**ï¼šåŸºæ–¼é—œéµå­—åŒ¹é…çš„å‚³çµ±æª¢ç´¢æ–¹æ³•
- **å‘é‡æª¢ç´¢**ï¼šåŸºæ–¼èªç¾©ç›¸ä¼¼åº¦çš„æ·±åº¦å­¸ç¿’æª¢ç´¢æ–¹æ³•

é€é Hybrid Search æŠ€è¡“ï¼Œç³»çµ±èƒ½å¤ åŒæ™‚åˆ©ç”¨é—œéµå­—åŒ¹é…å’Œèªç¾©ç†è§£ï¼Œæä¾›æ›´æº–ç¢ºçš„æª¢ç´¢çµæœã€‚

## âœ¨ åŠŸèƒ½ç‰¹è‰²

- ğŸ” **Hybrid Search**ï¼šçµåˆ BM25 å’Œå‘é‡æª¢ç´¢ï¼Œæä¾›æ›´å…¨é¢çš„æœå°‹çµæœ
- ğŸ†“ **å®Œå…¨å…è²»**ï¼šä½¿ç”¨ Hugging Face æœ¬åœ°æ¨¡å‹ï¼Œç„¡éœ€ API key
- ğŸš€ **GPU åŠ é€Ÿ**ï¼šæ”¯æ´ MPSï¼ˆmacOSï¼‰ã€CUDAï¼ˆNVIDIAï¼‰å’Œ CPU
- ğŸ“š **arXiv æ•´åˆ**ï¼šè‡ªå‹•å¾ arXiv ç²å–å­¸è¡“è«–æ–‡
- ğŸ—‚ï¸ **æ™ºèƒ½åˆ†å¡Š**ï¼šè‡ªå‹•å°‡é•·æ–‡æª”åˆ†å‰²æˆé©åˆæª¢ç´¢çš„ chunks
- ğŸ’¾ **æŒä¹…åŒ–å„²å­˜**ï¼šä½¿ç”¨ ChromaDB å„²å­˜å‘é‡è³‡æ–™åº«
- ğŸ”§ **å¯é…ç½®**ï¼šæ”¯æ´è‡ªå®šç¾©æ¨¡å‹ã€ç·©å­˜ç›®éŒ„ã€è¨­å‚™é¸æ“‡ç­‰

## ğŸ—ï¸ æŠ€è¡“æ¶æ§‹

### æ ¸å¿ƒæŠ€è¡“

- **LangChain**ï¼šç”¨æ–¼æ§‹å»º RAG æ‡‰ç”¨æ¡†æ¶
- **ChromaDB**ï¼šå‘é‡è³‡æ–™åº«ï¼Œç”¨æ–¼å„²å­˜å’Œæª¢ç´¢ embeddings
- **Hugging Face Transformers**ï¼šæä¾›å…è²»çš„ embedding æ¨¡å‹
- **BM25**ï¼šç¶“å…¸çš„é—œéµå­—æª¢ç´¢æ¼”ç®—æ³•
- **PyTorch**ï¼šæ·±åº¦å­¸ç¿’æ¡†æ¶ï¼Œæ”¯æ´ GPU åŠ é€Ÿ

### ç³»çµ±æ¶æ§‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Document       â”‚
â”‚  Processor      â”‚ â†’ æ–‡æª”ç²å–èˆ‡åˆ†å‰²
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
    â”‚         â”‚
â”Œâ”€â”€â”€â–¼â”€â”€â”€â” â”Œâ”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
â”‚ BM25  â”‚ â”‚ Vector  â”‚
â”‚Search â”‚ â”‚ Search  â”‚
â””â”€â”€â”€â”¬â”€â”€â”€â”˜ â””â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
    â”‚        â”‚
    â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
        â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Hybrid Searchâ”‚
â”‚   Results       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“š çŸ¥è­˜é»èªªæ˜

### 1. RAG (Retrieval-Augmented Generation)

RAG æ˜¯ä¸€ç¨®çµåˆæª¢ç´¢å’Œç”Ÿæˆçš„æŠ€è¡“ï¼Œé€šéä»¥ä¸‹æ­¥é©Ÿå·¥ä½œï¼š

1. **æª¢ç´¢éšæ®µ**ï¼šå¾å¤§é‡æ–‡æª”ä¸­æª¢ç´¢èˆ‡æŸ¥è©¢ç›¸é—œçš„å…§å®¹
2. **å¢å¼·éšæ®µ**ï¼šå°‡æª¢ç´¢åˆ°çš„å…§å®¹ä½œç‚ºä¸Šä¸‹æ–‡
3. **ç”Ÿæˆéšæ®µ**ï¼šåŸºæ–¼ä¸Šä¸‹æ–‡ç”Ÿæˆå›ç­”

æœ¬å°ˆæ¡ˆå°ˆæ³¨æ–¼**æª¢ç´¢éšæ®µ**ï¼Œæä¾›é«˜å“è³ªçš„æ–‡æª”æª¢ç´¢åŠŸèƒ½ã€‚

### 2. BM25 æª¢ç´¢

**BM25ï¼ˆBest Matching 25ï¼‰** æ˜¯ä¸€ç¨®åŸºæ–¼ TF-IDF æ”¹é€²çš„é—œéµå­—æª¢ç´¢æ¼”ç®—æ³•ï¼š

- **å„ªé»**ï¼š
  - å¿«é€Ÿä¸”é«˜æ•ˆ
  - å°ç²¾ç¢ºé—œéµå­—åŒ¹é…æ•ˆæœå¥½
  - ä¸éœ€è¦è¨“ç·´ï¼Œé–‹ç®±å³ç”¨
  
- **ç¼ºé»**ï¼š
  - ç„¡æ³•ç†è§£èªç¾©
  - å°åŒç¾©è©ä¸æ•æ„Ÿ
  - ä¾è³´é—œéµå­—åŒ¹é…

**é©ç”¨å ´æ™¯**ï¼šç•¶æŸ¥è©¢åŒ…å«æ˜ç¢ºé—œéµå­—æ™‚ï¼ŒBM25 è¡¨ç¾å„ªç§€ã€‚

### 3. å‘é‡æª¢ç´¢ï¼ˆSemantic Searchï¼‰

å‘é‡æª¢ç´¢ä½¿ç”¨æ·±åº¦å­¸ç¿’æ¨¡å‹å°‡æ–‡å­—è½‰æ›ç‚ºå‘é‡ï¼ˆembeddingsï¼‰ï¼Œç„¶å¾Œè¨ˆç®—å‘é‡é–“çš„ç›¸ä¼¼åº¦ï¼š

- **å„ªé»**ï¼š
  - ç†è§£èªç¾©å’Œä¸Šä¸‹æ–‡
  - å°åŒç¾©è©å’Œç›¸é—œæ¦‚å¿µæ•æ„Ÿ
  - èƒ½å¤ æ•æ‰èªç¾©ç›¸ä¼¼æ€§
  
- **ç¼ºé»**ï¼š
  - éœ€è¦è¨ˆç®—è³‡æºï¼ˆGPU åŠ é€Ÿï¼‰
  - å°ç²¾ç¢ºé—œéµå­—åŒ¹é…å¯èƒ½ä¸å¦‚ BM25
  - éœ€è¦é è¨“ç·´æ¨¡å‹

**é©ç”¨å ´æ™¯**ï¼šç•¶æŸ¥è©¢éœ€è¦èªç¾©ç†è§£æ™‚ï¼Œå‘é‡æª¢ç´¢è¡¨ç¾æ›´å¥½ã€‚

### 4. Hybrid Searchï¼ˆæ··åˆæœå°‹ï¼‰

Hybrid Search çµåˆ BM25 å’Œå‘é‡æª¢ç´¢çš„å„ªé»ï¼š

1. **ä¸¦è¡Œæª¢ç´¢**ï¼šåŒæ™‚åŸ·è¡Œ BM25 å’Œå‘é‡æª¢ç´¢
2. **åˆ†æ•¸æ­£è¦åŒ–**ï¼šå°‡å…©ç¨®åˆ†æ•¸è½‰æ›åˆ°ç›¸åŒç¯„åœ
3. **åŠ æ¬Šåˆä½µ**ï¼šæ ¹æ“šæ¬Šé‡åˆä½µå…©ç¨®åˆ†æ•¸
4. **çµæœæ’åº**ï¼šæŒ‰æ··åˆåˆ†æ•¸æ’åºè¿”å›çµæœ

**å„ªå‹¢**ï¼š
- åŒæ™‚åˆ©ç”¨é—œéµå­—åŒ¹é…å’Œèªç¾©ç†è§£
- æé«˜æª¢ç´¢çš„å¬å›ç‡å’Œæº–ç¢ºç‡
- é©æ‡‰ä¸åŒé¡å‹çš„æŸ¥è©¢

## ğŸš€ å¿«é€Ÿé–‹å§‹

### ç’°å¢ƒè¦æ±‚

- Python >= 3.13
- macOS / Linux / Windows
- ï¼ˆå¯é¸ï¼‰æ”¯æ´ MPS çš„ Apple Silicon Mac æˆ–æ”¯æ´ CUDA çš„ NVIDIA GPU

### å®‰è£æ­¥é©Ÿ

1. **å…‹éš†å°ˆæ¡ˆ**ï¼ˆå¦‚æœæœ‰çš„è©±ï¼‰æˆ–ç›´æ¥ä½¿ç”¨

2. **å®‰è£ä¾è³´**

```bash
# ä½¿ç”¨ uvï¼ˆæ¨è–¦ï¼‰
uv sync

# æˆ–ä½¿ç”¨ pip
pip install -r requirements.txt
```

3. **é‹è¡Œä¸»ç¨‹å¼**

```bash
python main.py
```

### é…ç½®é¸é …

#### ä½¿ç”¨å¤–æ¥ç¡¬ç¢Ÿå„²å­˜æ¨¡å‹

åœ¨ `main.py` ä¸­è¨­ç½®ï¼š

```python
hf_cache_dir = "/Volumes/YourExternalDrive/huggingface_cache"
```

æˆ–ä½¿ç”¨ç’°å¢ƒè®Šæ•¸ï¼š

```bash
export HF_CACHE_DIR="/Volumes/YourExternalDrive/huggingface_cache"
```

#### é¸æ“‡ä¸åŒçš„ Embedding æ¨¡å‹

```python
vector_retriever = VectorRetriever(
    documents,
    embedding_model="sentence-transformers/all-mpnet-base-v2",  # æ›´å¤§çš„æ¨¡å‹ï¼Œæ•ˆæœæ›´å¥½
    # embedding_model="sentence-transformers/all-MiniLM-L6-v2",  # é è¨­ï¼Œè¼•é‡ç´š
)
```

#### èª¿æ•´ Hybrid Search æ¬Šé‡

```python
hybrid_search = HybridSearch(
    bm25_retriever=bm25_retriever,
    vector_retriever=vector_retriever,
    bm25_weight=0.5,   # BM25 æ¬Šé‡ï¼ˆé è¨­ 0.4ï¼‰
    vector_weight=0.5  # å‘é‡æª¢ç´¢æ¬Šé‡ï¼ˆé è¨­ 0.6ï¼‰
)
```

## ğŸ“ å°ˆæ¡ˆçµæ§‹

```
Learn_RAG/
â”œâ”€â”€ main.py                    # ä¸»ç¨‹å¼å…¥å£
â”œâ”€â”€ src/                       # æ ¸å¿ƒæ¨¡çµ„
â”‚   â”œâ”€â”€ __init__.py           # å¥—ä»¶åˆå§‹åŒ–
â”‚   â”œâ”€â”€ document_processor.py # æ–‡æª”è™•ç†ï¼ˆarXiv ç²å–ã€åˆ†å¡Šï¼‰
â”‚   â”œâ”€â”€ bm25_retriever.py     # BM25 æª¢ç´¢å™¨
â”‚   â”œâ”€â”€ vector_retriever.py   # å‘é‡æª¢ç´¢å™¨
â”‚   â””â”€â”€ hybrid_search.py      # Hybrid Search æ ¸å¿ƒé‚è¼¯
â”œâ”€â”€ chroma_db/                 # ChromaDB å‘é‡è³‡æ–™åº«ï¼ˆè‡ªå‹•ç”Ÿæˆï¼‰
â”œâ”€â”€ pyproject.toml            # å°ˆæ¡ˆé…ç½®å’Œä¾è³´
â”œâ”€â”€ README.md                 # æœ¬æª”æ¡ˆ
â””â”€â”€ .gitignore                # Git å¿½ç•¥æª”æ¡ˆ
```

## ğŸ’¡ æ‡‰ç”¨å ´æ™¯

### 1. å­¸è¡“ç ”ç©¶

- **è«–æ–‡æª¢ç´¢**ï¼šå¿«é€Ÿæ‰¾åˆ°ç›¸é—œçš„å­¸è¡“è«–æ–‡
- **æ–‡ç»ç¶œè¿°**ï¼šè‡ªå‹•æ”¶é›†ç‰¹å®šä¸»é¡Œçš„æ–‡ç»
- **çŸ¥è­˜ç™¼ç¾**ï¼šç™¼ç¾ç ”ç©¶é ˜åŸŸçš„æ–°è¶¨å‹¢

### 2. ä¼æ¥­çŸ¥è­˜ç®¡ç†

- **å…§éƒ¨æ–‡æª”æª¢ç´¢**ï¼šå¿«é€Ÿæ‰¾åˆ°å…¬å¸å…§éƒ¨ç›¸é—œæ–‡æª”
- **æŠ€è¡“æ–‡æª”æœå°‹**ï¼šæœå°‹ API æ–‡æª”ã€æŠ€è¡“æ‰‹å†Šç­‰
- **FAQ ç³»çµ±**ï¼šåŸºæ–¼çŸ¥è­˜åº«çš„å•ç­”ç³»çµ±

### 3. å…§å®¹æ¨è–¦

- **ç›¸ä¼¼å…§å®¹æ¨è–¦**ï¼šåŸºæ–¼èªç¾©ç›¸ä¼¼åº¦æ¨è–¦ç›¸é—œå…§å®¹
- **å€‹æ€§åŒ–æœå°‹**ï¼šçµåˆç”¨æˆ¶æ­·å²çš„å€‹æ€§åŒ–æª¢ç´¢

### 4. å•ç­”ç³»çµ±

- **RAG å•ç­”**ï¼šçµåˆ LLM æ§‹å»ºæ™ºèƒ½å•ç­”ç³»çµ±
- **çŸ¥è­˜åº«å•ç­”**ï¼šåŸºæ–¼ä¼æ¥­çŸ¥è­˜åº«çš„å•ç­”

## ğŸ”§ é€²éšä½¿ç”¨

### è‡ªå®šç¾©æ–‡æª”ä¾†æº

é™¤äº† arXivï¼Œä½ å¯ä»¥æ“´å±• `DocumentProcessor` ä¾†æ”¯æ´å…¶ä»–è³‡æ–™ä¾†æºï¼š

```python
# åœ¨ document_processor.py ä¸­æ·»åŠ æ–°æ–¹æ³•
def fetch_from_pdf(self, pdf_path: str):
    # å¯¦ç¾ PDF è§£æé‚è¼¯
    pass
```

### èª¿æ•´åˆ†å¡Šç­–ç•¥

```python
processor = DocumentProcessor(
    chunk_size=1500,      # æ›´å¤§çš„ chunkï¼ˆé è¨­ 1000ï¼‰
    chunk_overlap=300    # æ›´å¤§çš„é‡ç–Šï¼ˆé è¨­ 200ï¼‰
)
```

### ä½¿ç”¨ GPU åŠ é€Ÿ

ç³»çµ±æœƒè‡ªå‹•æª¢æ¸¬å¯ç”¨çš„ GPUï¼š
- **MPS**ï¼šApple Silicon Macï¼ˆè‡ªå‹•å•Ÿç”¨ï¼‰
- **CUDA**ï¼šNVIDIA GPUï¼ˆè‡ªå‹•å•Ÿç”¨ï¼‰
- **CPU**ï¼šå‚™ç”¨é¸é …

ä¹Ÿå¯ä»¥æ‰‹å‹•æŒ‡å®šï¼š

```python
vector_retriever = VectorRetriever(
    documents,
    device='mps'  # å¼·åˆ¶ä½¿ç”¨ MPS
)
```

## ğŸ“Š æ€§èƒ½å„ªåŒ–å»ºè­°

1. **ä½¿ç”¨ GPU**ï¼šåœ¨æ”¯æ´çš„è¨­å‚™ä¸Šå•Ÿç”¨ GPU åŠ é€Ÿ
2. **èª¿æ•´æ¬Šé‡**ï¼šæ ¹æ“šæŸ¥è©¢é¡å‹èª¿æ•´ BM25 å’Œå‘é‡æª¢ç´¢çš„æ¬Šé‡
3. **é¸æ“‡æ¨¡å‹**ï¼šæ ¹æ“šéœ€æ±‚é¸æ“‡åˆé©å¤§å°çš„ embedding æ¨¡å‹
4. **åˆ†å¡Šç­–ç•¥**ï¼šæ ¹æ“šæ–‡æª”é¡å‹èª¿æ•´ chunk å¤§å°å’Œé‡ç–Š

## ğŸ¤ è²¢ç»

æ­¡è¿æäº¤ Issue å’Œ Pull Requestï¼

## ğŸ“ æˆæ¬Š

æœ¬å°ˆæ¡ˆåƒ…ä¾›å­¸ç¿’å’Œç ”ç©¶ä½¿ç”¨ã€‚

## ğŸ™ è‡´è¬

- [LangChain](https://www.langchain.com/) - RAG æ¡†æ¶
- [Hugging Face](https://huggingface.co/) - å…è²»çš„ embedding æ¨¡å‹
- [ChromaDB](https://www.trychroma.com/) - å‘é‡è³‡æ–™åº«
- [arXiv](https://arxiv.org/) - å­¸è¡“è«–æ–‡è³‡æ–™ä¾†æº

## ğŸ“– åƒè€ƒè³‡æº

- [RAG è«–æ–‡](https://arxiv.org/abs/2005.11401)
- [BM25 æ¼”ç®—æ³•](https://en.wikipedia.org/wiki/Okapi_BM25)
- [å‘é‡æª¢ç´¢åŸç†](https://www.pinecone.io/learn/vector-database/)
- [Hybrid Search æœ€ä½³å¯¦è¸](https://www.pinecone.io/learn/hybrid-search/)

---

**é–‹å§‹ä½ çš„ RAG ä¹‹æ—…ï¼** ğŸš€

